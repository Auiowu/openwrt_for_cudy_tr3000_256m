name: build-tr3000
permissions: write-all
on:
  push:
    tags:
      - "v*.*.*"
      - "v*.*.*-rc*"
jobs:
  build:
    name: build openwrt for cudy tr3000 (256MB v1)
    runs-on: ubuntu-24.04
    defaults:
      run:
        working-directory: ./openwrt
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: 初始化日志文件
        working-directory: ./
        run: |
          LOG_FILE="${{ github.workspace }}/build.log"
          echo "Build started at $(date)" > "$LOG_FILE"
          echo "LOG_FILE=$LOG_FILE" >> $GITHUB_ENV
        shell: bash

      - name: 更新系统并安装依赖
        working-directory: ./
        run: |
          {
            sudo apt update && sudo apt install -y build-essential clang flex bison \
            g++ gawk gcc-multilib g++-multilib gettext git \
            libncurses5-dev libssl-dev python3-setuptools rsync \
            swig unzip zlib1g-dev file wget
          } 2>&1 | tee -a $LOG_FILE
        shell: bash
        env:
          LOG_FILE: ${{ env.LOG_FILE }}

      - name: 下载OpenWrt源码（根据触发tag选择版本）
        working-directory: ./
        run: |
          {
            TAG="${{ github.ref_name }}"
            if git ls-remote --exit-code --tags https://github.com/openwrt/openwrt.git "refs/tags/$TAG" > /dev/null 2>&1; then
              echo "标签 $TAG 存在，使用该版本"
              git clone --depth 1 --branch "$TAG" https://github.com/openwrt/openwrt.git
            else
              echo "标签 $TAG 不存在，克隆默认分支"
              git clone --depth 1 https://github.com/openwrt/openwrt.git
            fi
          } 2>&1 | tee -a $LOG_FILE
        shell: bash
        env:
          LOG_FILE: ${{ env.LOG_FILE }}

      # ---------- 缓存配置 ----------
      - name: 缓存 ccache
        uses: actions/cache@v3
        with:
          path: |
            ~/.ccache
            openwrt/.ccache
          key: ccache-${{ runner.os }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ github.ref_name }}-
            ccache-${{ runner.os }}-

      - name: 缓存工具链和主机工具
        uses: actions/cache@v3
        with:
          path: |
            openwrt/staging_dir
            openwrt/build_dir/host
            openwrt/build_dir/toolchain-*
          key: toolchain-${{ runner.os }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            toolchain-${{ runner.os }}-${{ github.ref_name }}-
            toolchain-${{ runner.os }}-

      - name: 缓存 dl 目录
        uses: actions/cache@v3
        with:
          path: openwrt/dl
          key: dl-${{ runner.os }}-${{ github.ref_name }}-${{ github.sha }}
          restore-keys: |
            dl-${{ runner.os }}-${{ github.ref_name }}-
            dl-${{ runner.os }}-

      - name: 更新feeds（最多重试5次）
        run: |
          {
            for i in {1..5}; do
              echo "尝试第 $i 次更新 feeds..."
              if ./scripts/feeds update -a; then
                echo "feeds 更新成功"
                exit 0
              else
                echo "第 $i 次更新失败，等待 10 秒后重试..."
                sleep 10
              fi
            done
            echo "所有重试均失败，退出"
            exit 1
          } 2>&1 | tee -a $LOG_FILE
        shell: bash
        env:
          LOG_FILE: ${{ env.LOG_FILE }}

      - name: 安装feeds（最多重试5次）
        run: |
          {
            for i in {1..5}; do
              echo "尝试第 $i 次安装 feeds..."
              if ./scripts/feeds install -a; then
                echo "feeds 安装成功"
                exit 0
              else
                echo "第 $i 次安装失败，等待 10 秒后重试..."
                sleep 10
              fi
            done
            echo "所有重试均失败，退出"
            exit 1
          } 2>&1 | tee -a $LOG_FILE
        shell: bash
        env:
          LOG_FILE: ${{ env.LOG_FILE }}

      - name: 复制配置文件到源码目录
        run: |
          {
            cp ${{ github.workspace }}/.abc/.config .config
          } 2>&1 | tee -a $LOG_FILE
        shell: bash
        env:
          LOG_FILE: ${{ env.LOG_FILE }}

      - name: 复制设备树文件到源码目录
        run: |
          {
            cp ${{ github.workspace }}/.abc/mt7981b-cudy-tr3000-256mb-v1.dts target/linux/mediatek/dts/
          } 2>&1 | tee -a $LOG_FILE
        shell: bash
        env:
          LOG_FILE: ${{ env.LOG_FILE }}

      - name: 下载软件包源码
        run: |
          {
            make download -j4
          } 2>&1 | tee -a $LOG_FILE
        shell: bash
        env:
          LOG_FILE: ${{ env.LOG_FILE }}

      - name: 编译固件
        run: |
          {
            make -j4
          } 2>&1 | tee -a $LOG_FILE
        shell: bash
        env:
          LOG_FILE: ${{ env.LOG_FILE }}

      - name: 打包固件为zip
        if: success()
        run: |
          {
            VERSION="${TAG#v}"
            ZIP_NAME="openwrt-${VERSION}-cudy_tr3000_256_v1.zip"
            cd bin/targets/
            zip -r "${{ github.workspace }}/${ZIP_NAME}" .
            echo "ZIP_PATH=${{ github.workspace }}/${ZIP_NAME}" >> $GITHUB_ENV
          } 2>&1 | tee -a $LOG_FILE
        env:
          TAG: ${{ github.ref_name }}
          LOG_FILE: ${{ env.LOG_FILE }}
        shell: bash

      - name: 准备上传文件列表
        if: always()
        working-directory: ./
        run: |
          FILES="$LOG_FILE"
          if [ -n "$ZIP_PATH" ] && [ -f "$ZIP_PATH" ]; then
            FILES="$FILES $ZIP_PATH"
          fi
          echo "FILES=$FILES" >> $GITHUB_ENV
        env:
          LOG_FILE: ${{ env.LOG_FILE }}
          ZIP_PATH: ${{ env.ZIP_PATH }}
        shell: bash

      - name: 创建或更新Release并上传文件
        if: always()
        continue-on-error: true   # 避免因上传重试失败导致额外错误
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.FILES }}
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: |
            自动构建的 OpenWrt 固件，适用于 Cudy TR3000 (256MB v1)
            ${{ job.status == 'success' && '✅ 构建成功' || '❌ 构建失败（仅包含日志）' }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') }}
