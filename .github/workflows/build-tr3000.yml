name: build-tr3000
permissions: write-all
on:
  push:
    tags:
      - "v*.*.*"
      - "v*.*.*-rc*"
jobs:
  build:
    name: build openwrt for cudy tr3000 (256MB v1)
    runs-on: ubuntu-24.04
    defaults:
      run:
        working-directory: ./openwrt   # 后续步骤默认在此目录执行（需确保目录存在）
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # 初始化日志文件：需要在根目录运行（因为 openwrt 目录尚不存在）
      - name: 初始化日志文件
        working-directory: ./
        run: |
          LOG_FILE="${{ github.workspace }}/build.log"
          echo "Build started at $(date)" > "$LOG_FILE"
          echo "LOG_FILE=$LOG_FILE" >> $GITHUB_ENV
        shell: bash

      - name: 更新系统并安装依赖
        run: |
          {
            sudo apt update && sudo apt install -y build-essential clang flex bison \
            g++ gawk gcc-multilib g++-multilib gettext git \
            libncurses5-dev libssl-dev python3-setuptools rsync \
            swig unzip zlib1g-dev file wget
          } 2>&1 | tee -a $LOG_FILE
        shell: bash
        env:
          LOG_FILE: ${{ env.LOG_FILE }}

      - name: 下载OpenWrt源码（根据触发tag选择版本）
        working-directory: ./
        run: |
          {
            TAG="${{ github.ref_name }}"
            if git ls-remote --exit-code --tags https://github.com/openwrt/openwrt.git "refs/tags/$TAG" > /dev/null 2>&1; then
              echo "标签 $TAG 存在，使用该版本"
              git clone --depth 1 --branch "$TAG" https://github.com/openwrt/openwrt.git
            else
              echo "标签 $TAG 不存在，克隆默认分支"
              git clone --depth 1 https://github.com/openwrt/openwrt.git
            fi
          } 2>&1 | tee -a $LOG_FILE
        shell: bash
        env:
          LOG_FILE: ${{ env.LOG_FILE }}

      - name: 更新feeds
        run: |
          {
            ./scripts/feeds update -a
          } 2>&1 | tee -a $LOG_FILE
        shell: bash
        env:
          LOG_FILE: ${{ env.LOG_FILE }}

      - name: 安装feeds
        run: |
          {
            ./scripts/feeds install -a
          } 2>&1 | tee -a $LOG_FILE
        shell: bash
        env:
          LOG_FILE: ${{ env.LOG_FILE }}

      - name: 复制配置文件到源码目录
        run: |
          {
            cp ${{ github.workspace }}/.abc/.config .config
          } 2>&1 | tee -a $LOG_FILE
        shell: bash
        env:
          LOG_FILE: ${{ env.LOG_FILE }}

      - name: 复制设备树文件到源码目录
        run: |
          {
            cp ${{ github.workspace }}/.abc/mt7981b-cudy-tr3000-256mb-v1.dts target/linux/mediatek/dts/
          } 2>&1 | tee -a $LOG_FILE
        shell: bash
        env:
          LOG_FILE: ${{ env.LOG_FILE }}

      - name: 下载软件包源码
        run: |
          {
            make download -4
          } 2>&1 | tee -a $LOG_FILE
        shell: bash
        env:
          LOG_FILE: ${{ env.LOG_FILE }}

      - name: 编译固件
        run: |
          {
            make -j4
          } 2>&1 | tee -a $LOG_FILE
        shell: bash
        env:
          LOG_FILE: ${{ env.LOG_FILE }}

      - name: 打包固件为zip
        if: success()
        run: |
          {
            VERSION="${TAG#v}"
            ZIP_NAME="openwrt-${VERSION}-cudy_tr3000_256_v1.zip"
            cd bin/targets/
            zip -r "${{ github.workspace }}/${ZIP_NAME}" .
            echo "ZIP_PATH=${{ github.workspace }}/${ZIP_NAME}" >> $GITHUB_ENV
          } 2>&1 | tee -a $LOG_FILE
        env:
          TAG: ${{ github.ref_name }}
          LOG_FILE: ${{ env.LOG_FILE }}
        shell: bash

      # 准备上传文件列表：需要在根目录运行（因为要读取 $LOG_FILE 和 $ZIP_PATH）
      - name: 准备上传文件列表
        if: always()
        working-directory: ./
        run: |
          FILES="$LOG_FILE"
          if [ -n "$ZIP_PATH" ] && [ -f "$ZIP_PATH" ]; then
            FILES="$FILES $ZIP_PATH"
          fi
          echo "FILES=$FILES" >> $GITHUB_ENV
        env:
          LOG_FILE: ${{ env.LOG_FILE }}
          ZIP_PATH: ${{ env.ZIP_PATH }}
        shell: bash

      # 创建或更新 Release（uses 步骤不受 working-directory 影响）
      - name: 创建或更新Release并上传文件
        if: always()
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.FILES }}          # 空格分隔的字符串，该 Action 接受这种格式
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: |
            自动构建的 OpenWrt 固件，适用于 Cudy TR3000 (256MB v1)
            ${{ job.status == 'success' && '✅ 构建成功' || '❌ 构建失败（仅包含日志）' }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') }}
